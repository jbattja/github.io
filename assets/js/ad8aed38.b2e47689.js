"use strict";(self.webpackChunk_open_fabric_developer_docs=self.webpackChunk_open_fabric_developer_docs||[]).push([[4819],{28453(e,n,t){t.d(n,{R:()=>s,x:()=>c});var r=t(96540);const i={},a=r.createContext(i);function s(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(a.Provider,{value:n},e.children)}},64380(e,n,t){t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"AccountTokenization/OwnAppTokens/TokenizeExistingCard","title":"Own App Tokens","description":"Tokenize an existing card","source":"@site/docs/AccountTokenization/OwnAppTokens/TokenizeExistingCard.md","sourceDirName":"AccountTokenization/OwnAppTokens","slug":"/AccountTokenization/OwnAppTokens/TokenizeExistingCard","permalink":"/github.io/docs/AccountTokenization/OwnAppTokens/TokenizeExistingCard","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"Account Tokenization","permalink":"/github.io/docs/tags/account-tokenization"},{"inline":true,"label":"Own App Tokens","permalink":"/github.io/docs/tags/own-app-tokens"},{"inline":true,"label":"NFC","permalink":"/github.io/docs/tags/nfc"},{"inline":true,"label":"Tap and Pay","permalink":"/github.io/docs/tags/tap-and-pay"}],"version":"current","frontMatter":{"title":"Own App Tokens","tags":["Account Tokenization","Own App Tokens","NFC","Tap and Pay"]},"sidebar":"someSidebar","previous":{"title":"Tokenize your customer\'s account","permalink":"/github.io/docs/AccountTokenization/OwnAppTokens/TokenizeCustomerAccount"},"next":{"title":"Card activation and setting preference","permalink":"/github.io/docs/AccountTokenization/OwnAppTokens/ActivationPreferenceSettings"}}');var i=t(74848),a=t(28453);const s={title:"Own App Tokens",tags:["Account Tokenization","Own App Tokens","NFC","Tap and Pay"]},c="Own App Tokens",o={},d=[{value:"Tokenize an existing card",id:"tokenize-an-existing-card",level:2},{value:"Send card details via API",id:"send-card-details-via-api",level:2},{value:"Enroll the tokenized card into the secure device wallet",id:"enroll-the-tokenized-card-into-the-secure-device-wallet",level:3},{value:"Collecting card data from user",id:"collecting-card-data-from-user",level:2},{value:"Card Scanning via NFC Tap",id:"card-scanning-via-nfc-tap",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"own-app-tokens",children:"Own App Tokens"})}),"\n",(0,i.jsx)(n.h2,{id:"tokenize-an-existing-card",children:"Tokenize an existing card"}),"\n",(0,i.jsx)(n.p,{children:"In specific scenarios you might want to create Own App Tokens linked to an existing card. In such cases, our platform offers two distinct ways to facilitate this process:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"You can send the card details via API"}),"\n",(0,i.jsx)(n.li,{children:"Your customers can manually input their card details in our SDK"}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"In both scenarios it is possible to tokenize a card linked to a BIN which is not managed by Open Fabric. If you allow for this to happen, the payments processed on those tokens will not be reflected in Open Fabric's system."})}),"\n",(0,i.jsx)(n.h2,{id:"send-card-details-via-api",children:"Send card details via API"}),"\n",(0,i.jsxs)(n.p,{children:["To start the process of tokenizing an existing card into an Own App Token, please make sure you have created a secure device wallet as explained ",(0,i.jsx)(n.a,{href:"./CreateSecureDeviceWallet",children:"here"})]}),"\n",(0,i.jsx)(n.p,{children:"Once the device is ready with a secure device wallet provisioned, it\u2019s time to tokenize a card into the secure device wallet. You can provide card data to Open Fabric for tokenization, which will allow for push provisioning of the token into the secure device wallet"}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"For security reasons, it is essential to make the API call from the backend."})}),"\n",(0,i.jsxs)(n.p,{children:["Use the ",(0,i.jsx)(n.a,{href:"/apis#tag/Provision-Account/operation/pushProvisionCard",children:"Push provision API"}),", with the following parameters:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"digital_wallet"})," set to ",(0,i.jsx)(n.code,{children:"issuer"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"wallet_id"})," with the secure device wallet indicator"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"encrypted_card_data"})," with the encrypted card data JSON with Open Fabric\u2019s shared public key, Base64-encoded"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"issuer_card_id"})," with the issuer card ID, retrieved from your CMS"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"tenant_customer_ref"})," with a reference to the customer from your system"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The API will respond back to you with a ",(0,i.jsx)(n.code,{children:"provisioning_data.opc"})," which then needs to be handed back to the SDK for the next step."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Sample request"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Headers:\r\n  Idempotency-Key: 40709949-0712-487c-a2fe-1dd2e64af506\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n    "tsp": "mdes",\r\n    "digital_wallet": "issuer",\r\n    "tenant_customer_ref": "of_customer_1",\r\n    "issuer_card_id": "507e8c90-3cfc-44ee-b701-0630067eb44fa5e9351a-0a6",\r\n    "issuer_authentication_data": "eyJ4NWMiOlsiTUlJQzNqQ0NBY2FnQXdJQkFnSUpBT1FDdnc2Tjh...",\r\n    "encrypted_card_data": "eyJ4NWMiOlsiTUlJQzNqQ0NBY2FnQXdJQkFnSUpBT1FDdnc2Tjh...",\r\n    "wallet_id": "507e8c90-3cfc-44ee-b701-0630067eb44fa5e9351a-0a6",\r\n    "billing_address": {\r\n        "address_line_1": "Singapore",\r\n        "post_code": "000001"\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",metastring:'title="Unencrypted card data JSON"',children:'{\r\n    "card_number": "5...123",\r\n    "expiry_month": "12",\r\n    "expiry_year": "30"\r\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Sample response"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n    "wallet_id": "507e8c90-3cfc-44ee-b701-0630067eb44fa5e9351a-0a6",\r\n    "provisioning_data": {\r\n        "opc": "eyJ4NWMiOlsiTUlJQzNqQ0NBY2FnQXdJQkFnSUpBT1FDdnc2...",\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"enroll-the-tokenized-card-into-the-secure-device-wallet",children:"Enroll the tokenized card into the secure device wallet"}),"\n",(0,i.jsxs)(n.p,{children:["Now that we have tokenized the customer\u2019s card and generated the device opaque data (",(0,i.jsx)(n.code,{children:"provisioning_data.opc"}),"), it is time to enroll the tokenized account into the secure device wallet."]}),"\n",(0,i.jsxs)(n.p,{children:["To complete the setup, the device opaque data (",(0,i.jsx)(n.code,{children:"provisioning_data.opc"}),") should be injected into the SDK. Use the ",(0,i.jsx)(n.code,{children:"enrollAccount()"})," method to inject ",(0,i.jsx)(n.code,{children:"provisioning_data.opc"})," received in the previous step."]}),"\n",(0,i.jsxs)(n.p,{children:["If all goes well, the callback ",(0,i.jsx)(n.code,{children:"OpenfabricCallback#onSuccess()"})," is called. We will initiate the process of asynchronously pulling the payment cryptograms generated for the tokenized account. When this is complete, the app is notified with the callback ",(0,i.jsx)(n.code,{children:"CardEventListener#onCardsUpdated()"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["If an error occurs anytime during the above process, the callback ",(0,i.jsx)(n.code,{children:"OpenfabricCallback#onError()"})," is called, passing the reason for the error."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="Enroll Account"',children:"wallet.enrollCard(context, provisioningDataOpc), object : OpenfabricCallback<DigitizeAccountResponse> {\r\n  override fun onSuccess(response: DigitizeAccountResponse) {\r\n    // update provisioning state with enrollment succeeded\r\n  }\r\n\r\n  override fun onError(error: OpenFabricError) {\r\n    displayError(RuntimeException(error.message))\r\n  }\r\n})\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="CardListener.kt"',children:"class CardListener: CardEventListener {\r\n  override fun onCardsUpdated(context: Context) {\r\n    val intent = Intent(context, MainActivity::class.java)\r\n    intent.setAction(CardEventsReceiver.CARD_UPDATED)\r\n    LocalBroadcastManager.getInstance(context).sendBroadcast(intent)\r\n  }\r\n  ...\r\n}\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The registration of the listener is done by declaring the listener class in your manifest file under the key ",(0,i.jsx)(n.code,{children:"co.openfabric.nfc.CardEventListener"}),", as shown below:"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",metastring:'title="AndroidManifest.xml"',children:'<meta-data\r\n    android:name="co.openfabric.nfc.CardEventListener"            \r\n    android:value="mypackage.CardListener" />\n'})}),"\n",(0,i.jsxs)(n.p,{children:["After this step is done, you can continue with card activation and setting preference as described ",(0,i.jsx)(n.a,{href:"./ActivationPreferenceSettings",children:"here"})]}),"\n",(0,i.jsx)(n.h2,{id:"collecting-card-data-from-user",children:"Collecting card data from user"}),"\n",(0,i.jsxs)(n.p,{children:["To start the process of tokenizing an existing card into an Own App Token, please make sure you have created a secure device wallet as explained ",(0,i.jsx)(n.a,{href:"./CreateSecureDeviceWallet",children:"here"})]}),"\n",(0,i.jsx)(n.p,{children:"Once the device is ready with a secure device wallet provisioned, it\u2019s time to collect the user's card data for tokenization and push it into the secure wallet."}),"\n",(0,i.jsxs)(n.p,{children:["To initiate the secure session for collecting card data, use the ",(0,i.jsx)(n.code,{children:"requestCardTokenization()"})," method. If all goes well, the callback ",(0,i.jsx)(n.code,{children:"OpenfabricCallback#onSuccess()"})," is called with the session URL as an argument. We will initiate the process of asynchronously pulling the payment cryptograms generated for the tokenized card."]}),"\n",(0,i.jsxs)(n.p,{children:["If an error occurs, the callback ",(0,i.jsx)(n.code,{children:"OpenfabricCallback#onError()"})," is called, passing the reason for the error."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="Enroll Card"',children:"wallet.requestCardTokenization(object : OpenfabricCallback<String> {\r\n  override fun onSuccess(sessionUrl: String) {\r\n    // Open WebView with the session URL to start card data collection\r\n  }\r\n\r\n  override fun onError(error: OpenFabricError) {\r\n    displayError(RuntimeException(error.message))\r\n  }\r\n})\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now you should open the secure session URL in a WebView and present it to the user to start the card data collection and tokenization process. The process is handled securely between the user's device and Open Fabric backend. When this is complete, the app is notified with the callbacks ",(0,i.jsx)(n.code,{children:"CardEventListener#onCardsUpdated()"})," and ",(0,i.jsx)(n.code,{children:"CardEventListener#onCardActivated(context, cardId)"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="CardListener.kt"',children:"class CardListener: CardEventListener {\r\n  override fun onCardsUpdated(context: Context) {\r\n    val intent = Intent(context, MainActivity::class.java)\r\n    intent.setAction(CardEventsReceiver.CARD_UPDATED)\r\n    LocalBroadcastManager.getInstance(context).sendBroadcast(intent)\r\n  }\r\n\r\n  override fun onCardActivated(context: Context, cardId: String) {\r\n    val intent = Intent(context, MainActivity::class.java)\r\n    intent.setAction(CardEventsReceiver.CARD_ACTIVATED)\r\n    intent.putExtra(CardEventsReceiver.CARD_ID, cardId)\r\n    LocalBroadcastManager.getInstance(context).sendBroadcast(intent)\r\n  }\r\n  ...\r\n}\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The registration of the listener is done by declaring the listener class in your manifest file under the key ",(0,i.jsx)(n.code,{children:"co.openfabric.nfc.CardEventListener"}),", as shown below:"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",metastring:'title="AndroidManifest.xml"',children:'<meta-data\r\n    android:name="co.openfabric.nfc.CardEventListener"            \r\n    android:value="mypackage.CardListener" />\n'})}),"\n",(0,i.jsxs)(n.p,{children:["After this step is done, you can continue with card activation and setting preference as described ",(0,i.jsx)(n.a,{href:"./ActivationPreferenceSettings",children:"here"})]}),"\n",(0,i.jsx)(n.h3,{id:"card-scanning-via-nfc-tap",children:"Card Scanning via NFC Tap"}),"\n",(0,i.jsx)(n.p,{children:"We provide a helper method that configures the WebView to enable customers to tap their physical card on the device\u2019s NFC reader to automatically extract and pre-fill card information."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="WebView Activity"',children:"class WebViewActivity : AppCompatActivity() {\r\n    private lateinit var webView: WebView\r\n    private lateinit var callback: CardCollectionCallback\r\n\r\n    override fun onCreate(savedInstanceState: Bundle?) {\r\n        super.onCreate(savedInstanceState)\r\n        ...\r\n        HceHelper.setupCardCollectionCallback(\r\n            this,\r\n            webView,\r\n            callback\r\n        )\r\n        ...\r\n    }\r\n    ...\r\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To enable tap-to-read functionality for collecting card details via NFC, you must first configure the WebView using ",(0,i.jsx)(n.code,{children:"HceHelper.setupCardCollectionCallback(activity, webview, callback)"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["When a user successfully taps a card, and the device is able to parse the card details, the JavaScript function ",(0,i.jsx)(n.code,{children:"onCardDataReceived(pan, expiry)"})," will be called inside the WebView. The parameters ",(0,i.jsx)(n.code,{children:"pan"})," and ",(0,i.jsx)(n.code,{children:"expiry"})," contain the card number and expiry date respectively. Once this function is invoked, the device will automatically exit NFC reader mode."]}),"\n",(0,i.jsxs)(n.p,{children:["If the WebView activity is exited before the NFC tap flow is completed, such as if the user navigates away or closes the activity, it is important to restore the device\u2019s default NFC behavior. To do this, call ",(0,i.jsx)(n.code,{children:"HceHelper.enableHceService(activity)"})," from the host activity\u2019s ",(0,i.jsx)(n.code,{children:"onPause()"})," method. This ensures that the device resumes its normal NFC operations if the WebView does not complete the card collection process"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"CardCollectionCallback"})," interface is used to receive status updates through the Card Collection flow. It includes several callback methods:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="CardCollectionCallback.kt"',children:"// Callback interface for tracking events during the card collection flow via NFC.\r\ninterface CardCollectionCallback {\r\n\r\n  // Called when the card details form page has fully loaded and is ready for interaction.\r\n    //highlight-next\r\n  fun onFormReady()\r\n\r\n  // Called when __openfabric_js_bridge__.startCardScan() is invoked from the WebView and the device has entered NFC reader mode.\r\n    //highlight-next\r\n  fun onCardTapRequested()\r\n\r\n\r\n  // Called when a card has been successfully tapped and the card details are parsed correctly. The device will then exit NFC reader mode.\r\n    //highlight-next\r\n  fun onCardTapped()\r\n\r\n\r\n  // Called when an error occurs while attempting to parse the card details after tapping the card. The device will then exit NFC reader mode.\r\n    //highlight-next\r\n  fun onCardTapError()\r\n\r\n\r\n  // Called when the card is successfully added and the user reaches the success confirmation page.\r\n    //highlight-next\r\n  fun onCardAdded()\r\n\r\n  // Called when a generic error occurs that redirects the user to an error page.\r\n  //highlight-next\r\n  fun onError()\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"These callbacks allow the host application to respond appropriately at each stage of the tap-to-read process, ensuring a smooth and reliable integration."}),"\n",(0,i.jsxs)(n.p,{children:["After this step is done, you can continue with card activation and setting preference as described ",(0,i.jsx)(n.a,{href:"./ActivationPreferenceSettings",children:"here"})]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);