"use strict";(self.webpackChunk_open_fabric_developer_docs=self.webpackChunk_open_fabric_developer_docs||[]).push([[2422],{28453(e,n,t){t.d(n,{R:()=>o,x:()=>s});var r=t(96540);const i={},a=r.createContext(i);function o(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:n},e.children)}},45630(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"AccountTokenization/OwnAppTokens/TransactionInitiation","title":"Own App Tokens","description":"Overview","source":"@site/docs/AccountTokenization/OwnAppTokens/TransactionInitiation.md","sourceDirName":"AccountTokenization/OwnAppTokens","slug":"/AccountTokenization/OwnAppTokens/TransactionInitiation","permalink":"/github.io/docs/AccountTokenization/OwnAppTokens/TransactionInitiation","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"Account Tokenization","permalink":"/github.io/docs/tags/account-tokenization"},{"inline":true,"label":"Own App Tokens","permalink":"/github.io/docs/tags/own-app-tokens"},{"inline":true,"label":"NFC","permalink":"/github.io/docs/tags/nfc"},{"inline":true,"label":"Tap and Pay","permalink":"/github.io/docs/tags/tap-and-pay"}],"version":"current","frontMatter":{"title":"Own App Tokens","tags":["Account Tokenization","Own App Tokens","NFC","Tap and Pay"]},"sidebar":"someSidebar","previous":{"title":"Lifecycle management","permalink":"/github.io/docs/AccountTokenization/OwnAppTokens/LifeCycleManagement"},"next":{"title":"Digital Wallet Tokens","permalink":"/github.io/docs/AccountTokenization/DigitalWalletTokens"}}');var i=t(74848),a=t(28453);const o=t.p+"assets/images/AndroidContactlessPaymentsSettings-1b1fd57ab9eec233055e626d5bebc7f5.png",s={title:"Own App Tokens",tags:["Account Tokenization","Own App Tokens","NFC","Tap and Pay"]},c="Own App Tokens",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Handle Tap and Pay transactions",id:"handle-tap-and-pay-transactions",level:2},{value:"Present initial transaction experience",id:"present-initial-transaction-experience",level:3},{value:"Perform user authentication, if needed",id:"perform-user-authentication-if-needed",level:3},{value:"Provide final confirmation to our SDK to hand over a payment token",id:"provide-final-confirmation-to-our-sdk-to-hand-over-a-payment-token",level:3},{value:"Present In-progress experience",id:"present-in-progress-experience",level:3},{value:"Present transaction with terminal complete experience",id:"present-transaction-with-terminal-complete-experience",level:3},{value:"App configuration for optimal payment initiation outcome",id:"app-configuration-for-optimal-payment-initiation-outcome",level:2},{value:"Check and request to be the default payment provider app",id:"check-and-request-to-be-the-default-payment-provider-app",level:3},{value:"Payment application selection menu",id:"payment-application-selection-menu",level:3},{value:"Handle transaction as non-default foreground contactless payment application",id:"handle-transaction-as-non-default-foreground-contactless-payment-application",level:3},{value:"Disable/Enable contactless payment feature",id:"disableenable-contactless-payment-feature",level:3}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"own-app-tokens",children:"Own App Tokens"})}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"A customer initiates a transaction when he or she taps their device on an NFC payment terminal. Open Fabric\u2019s NFC SDK will intercept this transaction request and begin its interactions with your App. The App should then:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Present initial transaction experience"}),"\n",(0,i.jsx)(n.li,{children:"Perform user authentication, if needed"}),"\n",(0,i.jsx)(n.li,{children:"Provide final confirmation to our SDK to hand over a payment token"}),"\n",(0,i.jsx)(n.li,{children:"Present transaction in-progress experience"}),"\n",(0,i.jsx)(n.li,{children:"Present transaction with terminal complete experience"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Additionally, this document also covers ways by which your App can ensure that it is set up optimally to initiate transactions when the consumer tries to tap and pay - like for instance, set up as the default tap and pay provider, and your app is configured with appropriate foreground priority, etc."}),"\n",(0,i.jsx)(n.p,{children:"The diagram below provides an overview of all the interactions between all the key systems/components during the interaction stage."}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\r\n    autonumber\r\n    participant Customer\r\n    participant TenantApp as Your App\r\n    participant OFSDK as Open Fabric NFC SDK\r\n    participant Terminal as NFC Payment Terminal\r\n\r\n    Customer ->> Terminal: Tap\r\n    Terminal ->> OFSDK: Trigger NFC transaction\r\n    OFSDK ->> TenantApp: onTransactionStart()\r\n\r\n    rect rgb(240, 248, 255)\r\n        Note over TenantApp,Customer: 1. Present initial transaction experience\r\n        TenantApp ->> Customer: Present transaction experience\r\n    end\r\n\r\n    rect rgb(245, 245, 245)\r\n        Note over TenantApp,Customer: 2. Perform user authentication, if needed\r\n        OFSDK ->> TenantApp: onCredentialsRequired()\r\n        TenantApp ->> Customer: Present authentication prompt (ScreenUnlockAuthenticationPromptBuilder)\r\n\r\n        alt Authentication failed (user cancel or wrong credentials)\r\n            TenantApp ->> OFSDK: WalletManager.cancelOngoingTransaction()\r\n            OFSDK ->> TenantApp: onTransactionError()\r\n            TenantApp ->> Customer: Present transaction failed experience\r\n        else Authentication succeeded\r\n            OFSDK ->> Terminal: Try again (Step 2)\r\n        end\r\n    end\r\n\r\n    rect rgb(240, 255, 240)\r\n        Note over TenantApp,Customer: 3. Present transaction in-progress experience\r\n        OFSDK ->> TenantApp: onTransactionProgress()\r\n        TenantApp ->> Customer: Present in-progress experience\r\n\r\n        alt Transaction with terminal error\r\n            OFSDK ->> TenantApp: onTransactionError()\r\n            TenantApp ->> Customer: Present transaction failed experience\r\n        end\r\n    end\r\n\r\n    rect rgb(255, 248, 220)\r\n        Note over TenantApp,Customer: 4. Provide final confirmation to SDK to hand over payment token\r\n        OFSDK ->> TenantApp: onTransactionFinalization()\r\n        TenantApp ->> OFSDK: Decision\r\n\r\n        alt Decision is declined (false)\r\n            OFSDK ->> TenantApp: onTransactionError()\r\n            TenantApp ->> Customer: Present transaction failed status\r\n        end\r\n    end\r\n\r\n    OFSDK ->> Terminal: Hand over token key\r\n\r\n    rect rgb(255, 240, 245)\r\n        Note over TenantApp,Customer: 5. Present transaction complete experience\r\n        Terminal ->> OFSDK: Transaction is completed\r\n        OFSDK ->> TenantApp: onTransactionDone()\r\n        TenantApp ->> Customer: Present transaction complete experience\r\n\r\n        alt Transaction with terminal error\r\n            OFSDK ->> TenantApp: onTransactionError()\r\n            TenantApp ->> Customer: Present transaction failed experience\r\n        end\r\n    end\r\n\r\n    Terminal ->> Terminal: Process transaction with the network"}),"\n",(0,i.jsx)(n.h2,{id:"handle-tap-and-pay-transactions",children:"Handle Tap and Pay transactions"}),"\n",(0,i.jsx)(n.h3,{id:"present-initial-transaction-experience",children:"Present initial transaction experience"}),"\n",(0,i.jsxs)(n.p,{children:["Whenever a user taps their phone at an NFC payment terminal, our SDK will intercept the transaction request, and will then call the ",(0,i.jsx)(n.code,{children:"onTransactionStart()"})," callback on the ",(0,i.jsx)(n.code,{children:"NfcTransactionListener"}),". The application will need to present the initial transaction experience to the user."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="TransactionListener.kt"',children:"class TransactionListener: NfcTransactionListener {\r\n  override fun onTransactionStart(context: Context) {\r\n    PaymentActivity.displayPaymentStep(context, null)\r\n  }\r\n  ...\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Please refer to the integration sample app for a complete example."}),"\n",(0,i.jsxs)(n.p,{children:["Also note that the call to your ",(0,i.jsx)(n.code,{children:"NfcTransactionListener"})," will only happen in either of the following cases:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The user has set up your app as the default contactless payment app"}),"\n",(0,i.jsx)(n.li,{children:"The foreground priority is enabled, your app's activities are in the foreground and they have the implementation for foreground priority"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="PaymentActivity.kt"',children:"if (!HceHelper.isDefaultNfcPaymentApp(this)) {\r\n  if (HceHelper.isForegroundPriorityEnabled(this)) {\r\n    HceHelper.requestForegroundPaymentPriority(this)\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"perform-user-authentication-if-needed",children:"Perform user authentication, if needed"}),"\n",(0,i.jsx)(n.p,{children:"Now, you are required to perform any user authentication as needed. Depending on the wallet settings, this may be triggered in the following scenarios:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"When it exceeds a certain threshold (authentication duration, number of transactions) since the last authentication."}),"\n",(0,i.jsx)(n.li,{children:"When payment terminals classify transactions as high value and require additional authentication."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["When such authentication is required, the ",(0,i.jsx)(n.code,{children:"onCredentialsRequired()"})," callback on the ",(0,i.jsx)(n.code,{children:"NfcTransactionListener"})," will be called."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="TransactionListener.kt"',children:'class TransactionListener: NfcTransactionListener {\r\n  ...\r\n  override fun onCredentialsRequired(context: Context) {\r\n    ScreenUnlockAuthenticationPromptBuilder()\r\n            .setTitle("TITLE")\r\n            .setSubtitle("SUBTITLE")\r\n            .build(context)\r\n  }\r\n \r\n  ...\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"provide-final-confirmation-to-our-sdk-to-hand-over-a-payment-token",children:"Provide final confirmation to our SDK to hand over a payment token"}),"\n",(0,i.jsxs)(n.p,{children:["After user authentication is provided or if authentication is not required, the transaction will proceed to the finalization stage. At this stage, you can perform any additional validation/confirmation before you can confirm the transaction (like amount/currency check, account validity, transit eligibility, location based checks, etc.). This can be performed upon receiving the ",(0,i.jsx)(n.code,{children:"onTransactionFinalization()"})," callback on the ",(0,i.jsx)(n.code,{children:"NfcTransactionListener"}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"Please note that this callback is part of the transaction-critical processing thread, thus its implementation must be light and not blocking (e.g. synchronous network exchanges or UI interactions must not be implemented here)."})}),"\n",(0,i.jsx)(n.p,{children:"Following is the signature of the callback:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="TransactionListener.kt"',children:"class TransactionListener: NfcTransactionListener {\r\n  ...\r\n  override fun onTransactionFinalization(context: Context, transaction: NfcTransaction): TransactionDecision {\r\n    if (notAllowed(transaction)) {\r\n      return TransactionDecision(TransactionOutcome.DECLINE)\r\n    }\r\n\r\n    return TransactionDecision(TransactionOutcome.PROCEED)\r\n  }\r\n \r\n  ...\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"The callback is called with the following parameters:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Name"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"context"}),(0,i.jsx)(n.td,{children:"Context"}),(0,i.jsx)(n.td,{children:"The current Context (Activity)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"transaction"}),(0,i.jsx)(n.td,{children:"NfcTransaction"}),(0,i.jsx)(n.td,{children:"The current ongoing transaction"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"present-in-progress-experience",children:"Present In-progress experience"}),"\n",(0,i.jsxs)(n.p,{children:["While the transaction is ongoing, the following callback might be called by the SDK, to provide the payment app with updates regarding the current transaction. You should use the ",(0,i.jsx)(n.code,{children:"onTransactionProgress()"})," callback on the ",(0,i.jsx)(n.code,{children:"NfcTransactionListener"})," to update the UI and provide feedback to users."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"onTransactionProgress()"})," callback function indicates that the initiated NFC transaction has successfully initiated transfer of the payment token with the terminal."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="TransactionListener.kt"',children:"class TransactionListener: NfcTransactionListener {\r\n  ...\r\n  override fun onTransactionProgress(context: Context, step: HceTransactionStep, apdu: String) {\r\n    // Optional: update the screen showing the current step\r\n  }\r\n \r\n  ...\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"The callback is called with the following parameters:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Name"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"context"}),(0,i.jsx)(n.td,{children:"Context"}),(0,i.jsx)(n.td,{children:"The current Context (Activity)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"step"}),(0,i.jsx)(n.td,{children:"HceTransactionStep"}),(0,i.jsx)(n.td,{children:"The HceTransactionStep that has been completed, not null"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"apdu"}),(0,i.jsx)(n.td,{children:"String"}),(0,i.jsx)(n.td,{children:"The current APDU (Application Protocol Data Unit) value"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"present-transaction-with-terminal-complete-experience",children:"Present transaction with terminal complete experience"}),"\n",(0,i.jsxs)(n.p,{children:["Once the NFC exchange between the SDK and the payment terminal is completed for the transaction, the ",(0,i.jsx)(n.code,{children:"onTransactionDone()"})," callback on the ",(0,i.jsx)(n.code,{children:"NfcTransactionListener"})," will be called."]}),"\n",(0,i.jsx)(n.p,{children:"After this step the payment terminal may perform proprietary checks and in most cases it proceeds to an online authorization request to the network. The SDK simply considers the NFC exchange with the payment terminal is complete and will not be aware of decisions taken afterwards."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="TransactionListener.kt"',children:"class TransactionListener: NfcTransactionListener {\r\n  ...\r\n  override fun onTransactionDone(context: Context, result: TransactionResult) {\r\n    // Presents Transaction with terminal complete experience\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"The callback is called with the following parameters:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Name"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"context"}),(0,i.jsx)(n.td,{children:"Context"}),(0,i.jsx)(n.td,{children:"The current Context (Activity)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"result"}),(0,i.jsx)(n.td,{children:"TransactionResult"}),(0,i.jsx)(n.td,{children:"The final NFC exchange result of the transaction"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["If there is any error happening during the NFC exchange, for example if the customer chooses to cancel it or there is a connection issue with the terminal, the ",(0,i.jsx)(n.code,{children:"onTransactionError()"})," callback on the ",(0,i.jsx)(n.code,{children:"NfcTransactionListener"})," will also be called. The signature of the callback is as follows:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="TransactionListener.kt"',children:"class TransactionListener: NfcTransactionListener {\r\n  ...\r\n  override fun onTransactionError(context: Context, errorCode: string, exception: OpenFabricError?) {\r\n    // Display the error to user\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"app-configuration-for-optimal-payment-initiation-outcome",children:"App configuration for optimal payment initiation outcome"}),"\n",(0,i.jsxs)(n.p,{children:["While the basic integration with the Android platform has been covered in the ",(0,i.jsx)(n.a,{href:"../../Getting-Started/SDKs",children:"Getting Started section"}),", our NFC SDK provides additional helpers, to help you build further integration with the Android platform to optimize the customer experience thereby resulting in an optimal payment initiation outcome."]}),"\n",(0,i.jsx)(n.h3,{id:"check-and-request-to-be-the-default-payment-provider-app",children:"Check and request to be the default payment provider app"}),"\n",(0,i.jsx)(n.p,{children:"The SDK provides the following methods to check whether the current app is set as the default payment app and to quickly launch the setting page for users to select it as the default payment app."}),"\n",(0,i.jsxs)(n.p,{children:["Your application can use the method ",(0,i.jsx)(n.code,{children:"HceHelper#isDefaultNfcPaymentApp()"})," to check if the app is set as the default payment app on the customer\u2019s device. The method returns a boolean value true/false, indicating the status."]}),"\n",(0,i.jsxs)(n.p,{children:["The Android Platform does not allow an application to set itself as the default payment app without customer consent. However, we provide ",(0,i.jsx)(n.code,{children:"HceHelper#launchNfcPaymentSettings()"})," and ",(0,i.jsx)(n.code,{children:"HceHelper#launchNfcPaymentSettingsForResult()"})," convenience methods that the app can call to open the Android Settings page for Contactless Payment App."]}),"\n",(0,i.jsx)(n.h3,{id:"payment-application-selection-menu",children:"Payment application selection menu"}),"\n",(0,i.jsx)(n.p,{children:"Multiple payment apps can be installed on the same device and Android OS setting menu allows the customer to select a default payment app for NFC/Contactless payments. The default payment app is the app the NFC transactions are redirected to by Android system when device is tapped on an active terminal."}),"\n",(0,i.jsx)(n.p,{children:"This settings menu presents every payment app installed on the phone, with a description and a banner, so that users can select the one to set as the default payment app."}),"\n",(0,i.jsx)("img",{src:o,alt:"Android Choose your default Payment service"}),"\n",(0,i.jsxs)(n.p,{children:["To provide your own app name and payment banner, add the following resource override in your application ",(0,i.jsx)(n.code,{children:"strings.xml"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",metastring:'title="src/main/res/values/strings.xml"',children:'<resources>\r\n    ...\r\n    //highlight-start\r\n    <string name="tapandpayNfcDescription">Open Fabric NFC Tap and Pay Sample</string>\r\n    <drawable name="tapandpayApduBanner">@drawable/my_payment_banner</drawable>\r\n    //highlight-end\r\n</resources>\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The keys (",(0,i.jsx)(n.code,{children:"tapandpayNfcDescription"})," and ",(0,i.jsx)(n.code,{children:"tapandpayApduBanner"}),") must be kept exactly as they are, but you can provide your own text/image as the values."]}),"\n",(0,i.jsx)(n.h3,{id:"handle-transaction-as-non-default-foreground-contactless-payment-application",children:"Handle transaction as non-default foreground contactless payment application"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="MainActivity.kt"',children:"if (!HceHelper.isDefaultNfcPaymentApp(this)) {\r\n  if (HceHelper.isForegroundPriorityEnabled(this)) {\r\n    HceHelper.requestForegroundPaymentPriority(this)\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"disableenable-contactless-payment-feature",children:"Disable/Enable contactless payment feature"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-kotlin",metastring:'title="MainActivity.kt"',children:"// Disable contactless payment feature\r\nHceHelper.disableHceService()\r\n\r\n// Enable contactless payment feature\r\nHceHelper.enableHceService()\n"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}}}]);